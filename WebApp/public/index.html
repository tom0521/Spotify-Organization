<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spotify Organizer</title>
    <link rel="stylesheet" href="bootstrap-4.4.1-dist/css/bootstrap.min.css">
    <style type="text/css">
        #login, #loggedin {
        display: none;
        }
        body, html {
            height: 100%;
        }
        .container-fluid {
            height: 100%;
            max-height: 100%;
        }
        #loggedin {
            height: 100%;
            max-height: 100%;
        }
        .row {
            height: 100%;
            max-height: 100%;
        }
        .image-parent {
          max-width: 40px;
        }
        .card {
            max-height: calc(100vh - 2rem);
        }
        .list-group {
            overflow-y: auto;
        }
    </style>
  </head>

  <body>
    <div class="container-fluid">
      <div id="login">
        <a href="/login" class="btn btn-primary">Log in with Spotify</a>
      </div>
      <div id="loggedin">
          <div class="row align-items-center">
              <div class="col-4 p-3">
                  <div class="card" id="user-playlists"></div>
              </div>
              <div class="col-4 p-3">
                  <div class="card" id="buckets"></div>
              </div>
              <div class="col-4 p-3">
                  <div class="card" id="create">
                  </div>
              </div>
          </div>
      </div>
    </div>

    <!-- List Group Template -->
    <script id="list-template" type="text/x-handlebars-template">
        <div class="card-header">{{header}}</div>
        <div class="list-group" id="{{id}}-list">
            {{> loading-partial }}
        </div>
        <!-- If a footer is defined append it -->
        {{#if footer}}
            {{> (lookup . 'footer') }}
        {{/if}}
    </script>

    <!-- Loop items template -->
    <script id="list-items-template" type="text/x-handlebars-template">
        {{#each items}}
            {{> (lookup @root 'partial') }}
        {{/each}}
    </script>

    <!-- User Playlist Partial Template -->
    <script id="user-playlist-partial" type="text/x-handlebars-template">
        <button onclick="createBuckets('{{id}}')" class="list-group-item rounded-0 d-flex justify-content-between align-items-center">
            <div class="image-parent">
                {{#if images.0.url}}
                    <img src="{{images.0.url}}" class="img-fluid" alt="default">
                {{else}}
                    <img src="images/default.png" class="img-fluid" alt="default">
                {{/if}}
            </div>
            {{name}}
            <span class="badge badge-success badge-pill">{{tracks.total}} Songs</span>
        </button>
    </script>

    <!-- Sorted Playlist Partial Template -->
    <script id="bucket-partial" type="text/x-handlebars-template">
        <button onclick='getBucket("{{@key}}")' class="list-group-item rounded-0 d-flex justify-content-between align-items-center">
            {{@key}}
            <span class="badge badge-success badge-pill">{{total}} Songs</span>
        </button>
    </script>

    <!-- Song Partial Template -->
    <script id="song-partial" type="text/x-handlebars-template">
        <div class="list-group-item rounded-0 d-flex justify-content-between align-items-center">
            <div class="image-parent">
                <img src="{{album.images.0.url}}" class="img-fluid" alt="default">
            </div>
            <div>{{artists.0.name}}</div>
            <div>-</div>
            <div>{{name}}</div>
        </div>
    </script>

    <!-- Create Playlist Footer Partial -->
    <script id="create-footer-partial" type="text/x-handlebars-template">
        <div class="card-footer text-right">
            <button type="button" class="btn btn-success" onclick="createPlaylist()">Create Playlists</button>
        </div>
    </script>

    <!-- Loading Spinner Partial -->
    <script id="loading-partial" type="text/x-handlebars-template">
        <div class="text-center list-group-item">
            <div class="spinner-border text-success" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
    </script>

    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script type="text/javascript" src="bootstrap-4.4.1-dist/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.6/handlebars.min.js"></script>
    <script>
        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

        /* Register all the partials */
        Handlebars.registerPartial('user-playlist-partial', $('#user-playlist-partial').html());
        Handlebars.registerPartial('bucket-partial', $('#bucket-partial').html());
        Handlebars.registerPartial('song-partial', $('#song-partial').html());
        Handlebars.registerPartial('create-footer-partial', $('#create-footer-partial').html());
        Handlebars.registerPartial('loading-partial', $('#loading-partial').html());

        /* Compile the List Group Template and the List Items Temmplate */
        var listGroupTemplate = Handlebars.compile($('#list-template').html()),
            listTemplate = Handlebars.compile($('#list-items-template').html()),
            loadingTemplate = Handlebars.compile($('#loading-partial').html());

        /* Setup the User playlist column */
        $('#user-playlists').html(listGroupTemplate({
            header: 'Your Playlists',
            id: 'user-playlists'
        }));
        /* Setup the Buckets Column */
        $('#buckets').html(listGroupTemplate({
            header: 'Sorted Playlists',
            id: 'buckets'
        }));
        /* Setup the Create Playlist Column */
        $('#create').html(listGroupTemplate({
            header: 'Your New Playlist',
            id: 'create',
            footer: 'create-footer-partial'
        }));

        var params = getHashParams();

        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;


        /** Data structures
         *  playlists[id] = {
         *      tracks,
         *      artists,
         *      buckets
         *  }
         *  artists[id] = {
         *      artist info
         *  }
         *  tracks[id] = {
         *      track info
         *  }
         *  */

        var playlists = {
            saved: {
                id: 'saved',
                name: 'Saved Songs',
                artists: {},
                tracks: { total: 0 },
                buckets: {}
            }
        };
        var tracks = {};
        var artists = {};
        var chosenPlaylist;
        var chosenBucket;

        if (error) {
          alert('There was an error during the authentication');
        } else {
          if (access_token) {
            $('#login').hide();
            $('#loggedin').show();
            getSavedTracks();
          } else {
            $('#login').show();
            $('#loggedin').hide();
          }
        }

        function getSavedTracks(url='https://api.spotify.com/v1/me/tracks') {
            /* For all the songs in Saved Tracks, add it to the tracks, the artist to the artists,
                and the track id to the artists list in the playlist object, also sort the decades */
            $.ajax({
                url: url,
                data: {
                    limit: 50
                },
                headers: {
                    Authorization: 'Bearer ' + access_token
                },
                success: function (response) {
                    /* TODO: is there an easier way? */
                    for (let index in response.items) {
                        let track = response.items[index].track;
                        /* TODO: Remove duplicate code */
                        /* Add the track to the tracks */
                        tracks[track.id] = track;

                        /* Add the track to the playlist decade bucket */
                        let decade = getDecade(track);
                        playlists.saved.buckets[decade] = playlists.saved.buckets[decade] || {items: [], total: 0};
                        playlists.saved.buckets[decade].items.push(track.id);
                        playlists.saved.buckets[decade].total++;

                        /* Add the track to the playlist artist's track list */
                        playlists.saved.artists[track.artists[0].id] = playlists.saved.artists[track.artists[0].id] || { tracks:[] };
                        playlists.saved.artists[track.artists[0].id].tracks.push(track.id);
                    }
                    if (response.next) {
                        getSavedTracks(response.next);
                    } else {
                        playlists.saved.tracks.total = response.total;
                        getPlaylists();
                    }
                }
            });
        }

        function getPlaylists(url='https://api.spotify.com/v1/me/playlists') {
            $.ajax({
                url: url,
                data: {
                    limit: 50
                },
                headers: {
                    Authorization: 'Bearer ' + access_token
                },
                success: function (response) {
                    /* TODO: is there an easier way? */
                    for (let index in response.items) {
                        let id = response.items[index].id;
                        playlists[id] = response.items[index];
                        playlists[id].artists = {};
                        playlists[id].buckets = {};
                    }
                    if (response.next) {
                        getPlaylists(response.next);
                    } else {
                        /* TODO: #17 Fix this sorting */
                        // playlists.items.sort((a, b) => b.tracks.total - a.tracks.total);
                        $('#user-playlists-list').html(listTemplate({
                            partial: 'user-playlist-partial',
                            items: playlists
                        }));
                    }
                }
            });
        }

        function createBuckets(id) {
            /* clear the create playlist column */
            $('#buckets-list').html(loadingTemplate());
            $('#create-list').html(loadingTemplate());
            chosenPlaylist = id;

            if (id === 'saved') { /* If Saved songs chosen, skip getting tracks and go to sort artists */
                sortArtists(id);
            } else if (Object.keys(playlists[id].buckets).length === 0) { /* If this playlist buckets have not already been made, make them */
                getPlaylistTracks(id);
            } else { /* Otherwise, just display the buckets */
                $('#buckets-list').html(listTemplate({
                    partial: 'bucket-partial',
                    items: playlists[id].buckets
                }));
            }
        }

        function getPlaylistTracks(id, url=`https://api.spotify.com/v1/playlists/${id}/tracks`) {
            $.ajax({
                url: url,
                headers: {
                    Authorization: 'Bearer ' + access_token
                },
                success: function(response) {
                    for (let index in response.items) {
                        let track = response.items[index].track;
                        /* TODO: Put in separate function */
                        /* Add the track to the tracks */
                        tracks[track.id] = track;

                        /* Add the track to the playlist decade bucket */
                        let decade = getDecade(track);
                        playlists[id].buckets[decade] = playlists[id].buckets[decade] || {items: [], total: 0};
                        playlists[id].buckets[decade].items.push(track.id);
                        playlists[id].buckets[decade].total++;

                        /* Add the track to the playlist artist's track list */
                        playlists[id].artists[track.artists[0].id] = playlists[id].artists[track.artists[0].id] || { tracks:[] };
                        playlists[id].artists[track.artists[0].id].tracks.push(track.id);
                    }
                    if (response.next) {
                        getPlaylistTracks(id, response.next);
                    } else {
                        sortArtists(id);
                    }
                }
            });
        }

        function sortArtists(playlist_id) {
            let artist_ids = Object.keys(playlists[playlist_id].artists);
            let ids = [];
            for (let index in artist_ids) {
                if (artist_ids[index] in artists) {
                    putInBuckets(playlist_id, artist_ids[index]);
                } else {
                    ids.push(artist_ids[index]);
                }
            }
            if (ids.length === 0) {
                $('#buckets-list').html(listTemplate({
                    partial: 'bucket-partial',
                    items: playlists[playlist_id].buckets
                }));
            } else {
                getArtists(playlist_id, ids);
            }
        }

        function getArtists(playlist_id, artist_ids, offset = 0) {
            $.ajax({
                url: 'https://api.spotify.com/v1/artists',
                data: {
                    ids: artist_ids.slice(offset, offset+=50).join()
                },
                headers: {
                    Authorization: 'Bearer ' + access_token
                },
                success: function (response) {
                    for (let artist_index in response.artists) {
                        let artist = response.artists[artist_index];
                        artists[artist.id] = artist;
                        putInBuckets(playlist_id, artist.id);
                    }
                    if (offset < artist_ids.length) {
                        getArtists(playlist_id, artist_ids, offset);
                    } else {
                        /* TODO: #17 sort buckets by total songs */
                        $('#buckets-list').html(listTemplate({
                            partial: 'bucket-partial',
                            items: playlists[playlist_id].buckets
                        }));
                    }
                }
            });
        }

        function putInBuckets(playlist_id, artist_id) {
            for (let genre_index in artists[artist_id]['genres']) {
                let genre = artists[artist_id]['genres'][genre_index];
                /* Add the artist's tracks to the genre bucket */
                playlists[playlist_id].buckets[genre] = playlists[playlist_id].buckets[genre] || {items: [], total: 0};
                playlists[playlist_id].buckets[genre].items = playlists[playlist_id].buckets[genre].items.concat(playlists[playlist_id].artists[artist_id].tracks);
                playlists[playlist_id].buckets[genre].total += playlists[playlist_id].artists[artist_id].tracks.length;
            }
        }

        function getDecade(track) {
            var release_date = track['album']['release_date'];
            var decade = Math.floor(parseInt(release_date.substring(2, 4)) / 10) * 10;
            return `${decade.toString().padStart(2, '0')}'s`;
        }

        function getTracks(ids) {
            let bucket_tracks = [];
            for (let index in ids) {
                bucket_tracks.push(tracks[ids[index]]);
            }
            bucket_tracks.sort((a, b) => {
               if (a.artists[0].name == b.artists[0].name) {
                   return a.name.replace(/^(The )/, "").localeCompare(b.name.replace(/^(The )/, ""));
               }
               return a.artists[0].name.replace(/^(The )/, "").localeCompare(b.artists[0].name.replace(/^(The )/, ""));
            });
            $('#create-list').html(listTemplate({
                partial: 'song-partial',
                items: bucket_tracks
            }));
        }

        function getBucket(bucket) {
            chosenBucket = bucket;
            let ids = playlists[chosenPlaylist].buckets[bucket]['items'];
            getTracks(ids);
        }

        function createPlaylist() {
            $.ajax({
                url: 'https://api.spotify.com/v1/me',
                headers: {
                    Authorization: 'Bearer ' + access_token
                },
                success: function (response) {
                    $.ajax({
                        type: 'POST',
                        url: `https://api.spotify.com/v1/users/${response["id"]}/playlists`,
                        headers: {
                            Authorization: 'Bearer ' + access_token,
                            'Content-Type': 'application/json'
                        },
                        dataType: 'json',
                        data: JSON.stringify({
                            name: chosenBucket,
                            public: false
                        }),
                        success: function (res) {
                            addTracksToPlaylist (res['id']);
                        }
                    });
                }
            });
        }

        function addTracksToPlaylist (playlist_id, offset=0) {
            let uris = [];
            for (let index in playlists[chosenPlaylist].buckets[chosenBucket].items.slice(offset, offset+=100)) {
                uris.push(tracks[playlists[chosenPlaylist].buckets[chosenBucket].items[index]].uri);
            }
            $.ajax({
                type: 'POST',
                url: `https://api.spotify.com/v1/playlists/${playlist_id}/tracks`,
                headers: {
                    'Authorization': 'Bearer ' + access_token,
                    'Content-Type': 'applicaton/json'
                },
                dataType: 'json',
                data: JSON.stringify(uris),
                success: function (response) {
                    if (offset < playlists[chosenPlaylist].buckets[chosenBucket].total) {
                        addTracksToPlaylist(playlist_id, offset);
                    }
                }
            })
        }
    </script>
  </body>
</html>